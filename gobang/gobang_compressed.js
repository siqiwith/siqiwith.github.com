/**
 * Copyright © 2013 Siqi. All Rights Reserved.
 * Licensed under the GPL license.
 */
$(function(){var e="https://siqigobang.firebaseIO.com/",t=16,n=16,r="",i="#759DC0",s="#ffffff",o=!0,u="",a=null,f=!1,l=20;rootRef=new Firebase(e),sessionsRef=rootRef.child("sessions"),usersRef=rootRef.child("users");var c=new FirebaseSimpleLogin(rootRef,function(e,t){e||t==undefined||t.id==undefined?e&&alert(e):(a=t,$("#loginPane").css({display:"none"}),$("#userInfoPane").css({display:"block"}),$("#actionPane").css({display:"block"}),$("#userNameLabel").html(t.email))}),h=t*n;for(var p=0;p<n;p++)for(var d=0;d<t;d++)$("div#container").append('<div id="cell_'+p+"_"+d+'" class="cell"></div>');$("div#container").on("click",function(e){if(f&&/.*cell.*/.test(e.target.id)){changeTurn(!1),$(e.target).css({"background-color":o?i:s});var t=$(e.target).attr("id"),n=t.split("_"),r=sessionsRef.child(u),a=r.child(o?"hostSteps":"guestSteps");a.push({x:n[2],y:n[1]})}}),$("#login").on("click",function(){r=$("#userName").val(),password=$("#password").val(),c.login("password",{email:r,password:password,rememberMe:!1})}),$("#start").on("click",function(){o=!0,u=$("#sessionName").val();var e=sessionsRef.child(u);e.onDisconnect().remove(),e.once("value",function(t){var n=t.val();if(!n){usersRef.child(a.id).update({currentSession:u});var r={host:a.id,hostName:a.email,hostSteps:[]};e.update(r,function(t){if(t)alert(t);else{printLog("***Waiting for player to join.***"),e.on("value",function(t){var n=t.val();n&&n.guest&&(e.off("value"),printLog("***Guest joined game.***"),printLog("Host: "+n.hostName),printLog("Guest: "+n.guestName),printLog("******************"),changeTurn(!0))});var n=e.child(o?"guestSteps":"hostSteps");n.on("child_added",function(e){var t=e.val();$("#cell_"+t.y+"_"+t.x).css({"background-color":s}),changeTurn(!0)})}})}else printLog("Game already exists!.")})}),$("#join").on("click",function(){o=!1,u=$("#sessionName").val();var e=sessionsRef.child(u);e.onDisconnect().remove(),e.once("value",function(t){var n=t.val();if(n&&n.host){usersRef.child(a.id).update({currentSession:u});var r={guest:a.id,guestName:a.email,guestSteps:[]};e.update(r,function(t){t?alert(t):e.once("value",function(t){var n=t.val();printLog("***Joined game.***"),printLog("Host: "+n.hostName),printLog("Guest: "+n.guestName),printLog("******************"),changeTurn(!1);var r=e.child(o?"guestSteps":"hostSteps");r.on("child_added",function(e){var t=e.val();$("#cell_"+t.y+"_"+t.x).css({"background-color":i}),changeTurn(!0)})})})}else printLog("Cannot find the game.")})}),printLog=function(t){$("#logPane").append('<div class="log">'+t+"</div>"),$("#logPane").children().length>l&&$("#logPane").children().first().remove()},changeTurn=function(t){f=t,f?(printLog("It's your turn now."),$("#container").css({cursor:"pointer"})):(printLog("It's opponent's turn now."),$("#container").css({cursor:"auto"}))}})